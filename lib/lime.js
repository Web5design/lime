// Generated by CoffeeScript 1.3.1
(function() {
  var Annotation, URI,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; };

  window.LIMEPlayer = (function() {

    LIMEPlayer.name = 'LIMEPlayer';

    function LIMEPlayer(opts) {
      var options,
        _this = this;
      options = {
        containerDiv: "mainwrapper",
        videoPlayerSize: {
          "width": 640,
          "height": 360
        },
        annotFrameworkURL: "http://labs.newmedialab.at/SKOS/",
        plugins: {
          TestPlugin: {}
        },
        platform: "web",
        fullscreen: false,
        fullscreenLayout: {
          "AnnotationNorth": 50,
          "AnnotationWest": 300,
          "AnnotationSouth": 50,
          "AnnotationEast": 300
        },
        widgetContainers: [
          {
            element: jQuery('#widget-container-1'),
            orientation: 'vertical'
          }
        ],
        usedSpaceNWSE: {
          "north": 0,
          "west": 0,
          "south": 0,
          "east": 0
        },
        annotationsVisible: true,
        debug: false,
        preferredLanguage: "en",
        builtinPlugins: {
          AnnotationOverlays: {}
        }
      };
      this.options = $.extend(options, opts);
      this.widgetContainers = this.options.widgetContainers;
      this._initVideoPlayer(function() {
        return _this._loadAnnotations(function() {
          return _this._initPlugins(function() {
            return _this._startScheduler();
          });
        });
      });
    }

    LIMEPlayer.prototype._startScheduler = function() {
      /* handle becomeActive and becomeInactive events
      */
      return jQuery(this).bind('timeupdate', function(e) {
        var annotation, currentTime, _i, _len, _ref, _results;
        _ref = this.annotations;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          annotation = _ref[_i];
          currentTime = e.currentTime;
          if (annotation.state === 'inactive' && annotation.start < currentTime && annotation.end + 1 > currentTime) {
            annotation.state = 'active';
            jQuery(annotation).trigger(jQuery.Event("becomeActive", {
              annotation: annotation
            }));
          }
          if (annotation.state === 'active' && (annotation.start > currentTime || annotation.end + 1 < currentTime)) {
            annotation.state = 'inactive';
            _results.push(jQuery(annotation).trigger(jQuery.Event("becomeInactive", {
              annotation: annotation
            })));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      });
    };

    LIMEPlayer.prototype._initVideoPlayer = function(cb) {
      var displaysrc, i, source, _i, _len, _ref,
        _this = this;
      displaysrc = '';
      _ref = this.options.video;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        source = _ref[i];
        displaysrc = displaysrc + ("<source src=" + source + " type='video/" + (source.match(/.([a-z|A-Z|0-9]*)$/)[1]) + "' />");
      }
      $("#" + this.options.containerDiv).append("<div class='videowrapper' id='videowrapper'>\n  <video id='video_player' class='video-js vjs-default-skin' controls preload='none' width='640' height='360' poster='img/connectme-video-poster.jpg'>\n    " + displaysrc + "\n  </video>\n</div>\n<div class=\"annotation-wrapper\" id=\"annotation-wrapper\" style=\"display: none;\">\n<div class=\"north fullscreen-annotation\" style=\"height: " + this.options.fullscreenLayout.AnnotationNorth + "px\"></div>\n  <div class=\"west fullscreen-annotation\" style=\"height: " + this.options.fullscreenLayout.AnnotationSouth + "px\"></div>\n  <div class=\"east fullscreen-annotation\" style=\"height: " + this.options.fullscreenLayout.AnnotationEast + "px\"></div>\n  <div class=\"south fullscreen-annotation\" style=\"height: " + this.options.fullscreenLayout.AnnotationNorth + "px\"></div>\n</div>");
      return _.defer(function() {
        _this.player = _V_('video_player', {
          flash: {
            iFrameMode: true
          },
          swf: "lib/videojs/video-js.swf"
        });
        _this.player.addEvent("loadedmetadata", function() {
          _this._initEventListeners();
          return cb();
        });
        return _this.player.ready(function() {
          var nonfullscreen_containers;
          _this.player.isFullScreen = _this.options.fullscreen;
          nonfullscreen_containers = LimePlayer.widgetContainers;
          _this.player.addComponent("AnnotationsSidebars");
          _this.player.controlBar.addComponent("AnnotationToggle");
          if (!_this.player.isFullScreen) {
            _this.player.AnnotationsSidebars.hide();
          } else {
            _this.player.AnnotationsSidebars.show();
          }
          _this.player.play();
          return console.info("Setting up VideoJS Player", _this.player);
        });
      });
    };

    LIMEPlayer.prototype._initEventListeners = function() {
      var _this = this;
      this.player.addEvent('timeupdate', function(playerEvent) {
        var e;
        e = jQuery.Event("timeupdate", {
          currentTime: _this.player.currentTime()
        });
        return jQuery(_this).trigger(e);
      });
      return this.player.addEvent('fullscreenchange', function(e) {
        var fsce;
        fsce = jQuery.Event('fullscreenchange', {
          isFullScreen: _this.player.isFullScreen
        });
        jQuery(_this.player).trigger(fsce);
        return _this._moveWidgets(_this.player.isFullScreen);
      });
    };

    LIMEPlayer.prototype._loadAnnotations = function(cb) {
      var query, uri,
        _this = this;
      console.info("Loading annotations from LMF");
      this.annotations = [];
      query = "PREFIX oac: <http://www.openannotation.org/ns/>\nPREFIX ma: <http://www.w3.org/ns/ma-ont#>\nSELECT ?annotation ?fragment ?resource ?relation\nWHERE { <" + this.options.video[0] + ">  ma:hasFragment ?f.\n   ?f ma:locator ?fragment.\n   ?annotation oac:target ?f.\n   ?annotation oac:body ?resource.\n   ?f ?relation ?resource.\n}";
      uri = "" + this.options.annotFrameworkURL + "sparql/select?query=" + (encodeURIComponent(query)) + "&output=json";
      return $.getJSON(uri, function(data) {
        var annotation, i, list;
        list = data.results.bindings;
        for (i in list) {
          annotation = list[i];
          _this.annotations.push(new Annotation(annotation));
        }
        console.info("Annotations loaded from", uri, _this.annotations);
        return cb();
      });
    };

    LIMEPlayer.prototype._moveWidgets = function(isFullscreen) {
      var annotation, _i, _len, _ref;
      console.log("fullscreen", isFullscreen, ", Visible " + LimePlayer.options.annotationsVisible);
      if (isFullscreen && LimePlayer.options.annotationsVisible) {
        LimePlayer.widgetContainers = [
          {
            element: jQuery('.west'),
            orientation: 'vertical'
          }, {
            element: jQuery('.north'),
            orientation: 'horizontal'
          }, {
            element: jQuery('.east'),
            orientation: 'vertical'
          }, {
            element: jQuery('.south'),
            orientation: 'horizontal'
          }
        ];
        LimePlayer.player.AnnotationsSidebars.show();
      } else {
        LimePlayer.widgetContainers = nonfullscreen_containers;
        LimePlayer.player.AnnotationsSidebars.hide();
      }
      _ref = LimePlayer.annotations;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        annotation = _ref[_i];
        if (annotation.state === 'active') {
          jQuery(annotation).trigger(jQuery.Event("becomeInactive", {
            annotation: annotation
          }));
          jQuery(annotation).trigger(jQuery.Event("becomeActive", {
            annotation: annotation
          }));
        }
      }
      return console.info("_moveWidgets", isFullscreen);
    };

    LIMEPlayer.prototype._initPlugins = function(cb) {
      var options, pluginClass, _ref, _ref1;
      this.plugins = [];
      _ref = this.options.builtinPlugins;
      for (pluginClass in _ref) {
        options = _ref[pluginClass];
        this.plugins.push(new window[pluginClass](this, options));
      }
      _ref1 = this.options.plugins;
      for (pluginClass in _ref1) {
        options = _ref1[pluginClass];
        this.plugins.push(new window[pluginClass](this, options));
      }
      return cb();
    };

    LIMEPlayer.prototype.allocateWidgetSpace = function(options) {
      var container, res,
        _this = this;
      if (options && options.preferred && this._hasFreeSpace(options.preferred, options)) {
        container = options.preferred;
      } else {
        container = _(this.widgetContainers).detect(function(cont) {
          return _this._hasFreeSpace(cont, options);
        });
      }
      if (container) {
        container.element.prepend("<div class='lime-widget'></div>");
        res = jQuery(".lime-widget:first", container.element);
        console.info('widgetspace allocated', res[0]);
        return res;
      } else {
        console.error("There's not enough space for a widget to be shown!");
        if (this.options.debug) {
          debugger;
        }
        return false;
      }
      /*
          container = _(@widgetContainers).detect (cont) =>
            @_hasFreeSpace cont, options
          if container
            container.element.prepend "<div class='lime-widget'>123</div>"
            jQuery('.lime-widget:first', container.element)
          else
            no
      */

    };

    LIMEPlayer.prototype._hasFreeSpace = function(container, options) {
      var currentHeight, maxHeight;
      currentHeight = container.element.height();
      maxHeight = parseInt(container.element.css("max-height"));
      if ((!maxHeight) || (maxHeight === NaN)) {
        maxHeight = $(window).height() - 300;
      }
      if (maxHeight - currentHeight < 200) {
        return false;
      } else {
        return true;
      }
    };

    LIMEPlayer.prototype.getAnnotationsFor = function(uri, cb) {};

    return LIMEPlayer;

  })();

  Annotation = (function() {

    Annotation.name = 'Annotation';

    function Annotation(hash) {
      var fragmentHash, startEnd, t, xywh, _ref, _ref1, _ref2, _ref3,
        _this = this;
      this.annotation = hash.annotation.value;
      this.start = 0;
      this.end = -1;
      this.state = 'inactive';
      this.widgets = {};
      jQuery(this).bind("mouseenter", function(e) {
        var widget, widgetname, _ref, _results;
        _ref = _this.widgets;
        _results = [];
        for (widgetname in _ref) {
          widget = _ref[widgetname];
          _results.push(jQuery(widget).addClass("hover"));
        }
        return _results;
      });
      jQuery(this).bind("mouseleave", function(e) {
        var widget, widgetname, _ref, _results;
        _ref = _this.widgets;
        _results = [];
        for (widgetname in _ref) {
          widget = _ref[widgetname];
          _results.push(jQuery(widget).removeClass("hover"));
        }
        return _results;
      });
      if (hash.fragment.type = 'uri') {
        this.fragment = new URI(hash.fragment.value);
        fragmentHash = this.fragment.hash;
        t = fragmentHash.match(/t=([0-9,]*)/);
        if (t) {
          t = t[1];
          startEnd = t.match(/([0-9]{1,})/g);
          if (startEnd) {
            this.start = Number(startEnd[0]);
            this.end = Number(startEnd[1]) || -1;
          }
        }
        xywh = fragmentHash.match(/xywh=([a-z0-9,:]*)/);
        if (xywh) {
          this.isPercent = xywh[1].indexOf('percent') !== -1;
          _ref = _(xywh[1].match(/([0-9]{1,})/g)).map(function(n) {
            return Number(n);
          }), this.x = _ref[0], this.y = _ref[1], this.w = _ref[2], this.h = _ref[3];
        }
      }
      this.isSpacial = this.x !== void 0 || ((((this.x === (_ref3 = this.y) && _ref3 === (_ref2 = this.w)) && _ref2 === (_ref1 = this.h)) && _ref1 === 0));
      this.resource = new URI(hash.resource.value);
      this.relation = new URI(hash.relation.value);
    }

    Annotation.prototype.toString = function() {
      return this.resource.value;
    };

    return Annotation;

  })();

  URI = (function() {

    URI.name = 'URI';

    function URI(uri) {
      var hash;
      this.value = decodeURIComponent(uri);
      hash = uri.match(/^.*?#([a-zA-Z0-9,&=:]*)$/);
      if (hash) {
        this.hash = hash[1];
      } else {
        this.hash = '';
      }
      this.type = 'uri';
    }

    URI.prototype.toString = function() {
      return this.value;
    };

    return URI;

  })();

  window.LimePlugin = (function() {

    LimePlugin.name = 'LimePlugin';

    function LimePlugin(lime, options) {
      this.lime = lime;
      this.options = jQuery.extend(options, this.defaults);
      this.init();
    }

    LimePlugin.prototype.defaults = {};

    LimePlugin.prototype.init = function() {
      return console.error("All Lime plugins have to implement the init method!");
    };

    return LimePlugin;

  })();

  window.TestPlugin = (function(_super) {

    __extends(TestPlugin, _super);

    TestPlugin.name = 'TestPlugin';

    function TestPlugin() {
      return TestPlugin.__super__.constructor.apply(this, arguments);
    }

    TestPlugin.prototype.init = function() {
      var annotation, _i, _len, _ref, _results,
        _this = this;
      console.info("Initialize TestPlugin");
      jQuery(this.lime).bind('timeupdate', function(e) {
        return console.info('plugin timeupdate event', e.currentTime);
      });
      _ref = this.lime.annotations;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        annotation = _ref[_i];
        jQuery(annotation).bind('becomeActive', function(e) {
          var domEl;
          console.info(e.annotation, 'became active');
          domEl = _this.lime.allocateWidgetSpace();
          if (domEl) {
            domEl.html("<a href='" + e.annotation.resource + "' target='_blank'>" + e.annotation.resource + "</a>");
            if (e.annotation.ldLoaded) {
              domEl.html(_this.renderAnnotation(e.annotation));
            } else {
              jQuery(e.annotation).bind('ldloaded', function(e2) {
                return domEl.html(_this.renderAnnotation(e2.annotation));
              });
            }
            return e.annotation.widgets.TestPlugin = domEl;
          } else {

          }
        });
        _results.push(jQuery(annotation).bind("becomeInactive", function(e) {
          console.info(e.annotation, 'became inactive');
          e.annotation.widgets.TestPlugin.remove();
          if (e.annotation.widgets) {
            return delete e.annotation.widgets.TestPlugin;
          } else {
            debugger;
          }
        }));
      }
      return _results;
    };

    TestPlugin.prototype.renderAnnotation = function(annotation) {
      var depiction, label, page, props, _ref, _ref1;
      props = annotation.entity[annotation.resource.value];
      label = _(props['http://www.w3.org/2000/01/rdf-schema#label']).detect(function(labelObj) {
        return labelObj.lang === 'en';
      }).value;
      depiction = (_ref = props['http://xmlns.com/foaf/0.1/depiction']) != null ? _ref[0].value : void 0;
      page = (_ref1 = props['http://xmlns.com/foaf/0.1/page']) != null ? _ref1[0].value : void 0;
      return "<p>\n  <a href=\"" + page + "\" target=\"_blank\">" + label + "</a>\n</p>\n<p>\n  <img src=\"" + depiction + "\" width=\"200\"/>\n</p>";
    };

    return TestPlugin;

  })(window.LimePlugin);

  _V_.AnnotationToggle = _V_.Button.extend({
    buttonText: "Annotations On/Off",
    buildCSSClass: function() {
      return "vjs-annotationstoggler " + this._super();
    },
    onClick: function() {
      if (LimePlayer.options.annotationsVisible === false) {
        $(".vjs-annotationstoggler").removeClass("annotationstoggler-off");
        LimePlayer.options.annotationsVisible = true;
        if (LimePlayer.player.AnnotationOverlaysComponent) {
          LimePlayer.player.AnnotationOverlaysComponent.show();
        }
        if (this.player.isFullScreen) {
          LimePlayer.player.AnnotationsSidebars.show();
        } else {
          LimePlayer.player.AnnotationsSidebars.hide();
        }
      } else {
        $(".vjs-annotationstoggler").addClass("annotationstoggler-off");
        LimePlayer.player.AnnotationsSidebars.hide();
        if (LimePlayer.player.AnnotationOverlaysComponent) {
          LimePlayer.player.AnnotationOverlaysComponent.hide();
        }
        LimePlayer.options.annotationsVisible = false;
      }
      return console.log("fullscreen " + this.player.isFullScreen, "visible " + LimePlayer.options.annotationsVisible);
    }
  });

  _V_.AnnotationsSidebars = _V_.Component.extend({
    options: {
      loadEvent: "play"
    },
    init: function(player, options) {
      this._super(player, options);
      player.addEvent("fullscreenchange", this.proxy(function() {
        if (this.player.isFullScreen === false) {
          return this.hide();
        }
      }));
      player.addEvent("play", this.proxy(function() {
        this.fadeIn();
        return this.player.addEvent("mouseover", this.proxy(this.fadeIn));
      }));
      return this.player.AnnotationsSidebars = this;
    },
    createElement: function() {
      return $(".annotation-wrapper", this.el).show()[0];
    },
    fadeIn: function() {
      return this._super();
    },
    fadeOut: function() {
      return this._super();
    },
    lockShowing: function() {
      return this.el.style.opacity = "1";
    }
  });

  window.AnnotationOverlays = (function(_super) {

    __extends(AnnotationOverlays, _super);

    AnnotationOverlays.name = 'AnnotationOverlays';

    function AnnotationOverlays() {
      return AnnotationOverlays.__super__.constructor.apply(this, arguments);
    }

    AnnotationOverlays.prototype.init = function() {
      var annotation, container, limeplayer, _i, _len, _ref, _results,
        _this = this;
      console.info("Initialize AnnotationOverlays");
      this.lime.player.addComponent("AnnotationOverlaysComponent");
      this.lime.player.AnnotationOverlaysComponent.show();
      container = jQuery(".annotation-overlays-wrapper", this.lime.player.el);
      limeplayer = this.lime;
      jQuery(this.lime).bind("timeupdate", function(e) {});
      _ref = this.lime.annotations;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        annotation = _ref[_i];
        jQuery(annotation).bind("becomeActive", function(e) {
          var domEl;
          annotation = e.annotation;
          if (annotation.end === 5) {
            console.info(annotation);
          }
          if (annotation.isSpacial && (annotation.w > 0) && (annotation.h > 0)) {
            container.prepend(_this.renderAnnotation(annotation));
            domEl = jQuery(".spatial_annotation:first", container);
            jQuery(domEl).data('annotation', annotation);
            domEl.mouseenter(function(e) {
              var mouseenterEvent;
              annotation = jQuery(e.target).data().annotation;
              mouseenterEvent = jQuery.Event("mouseenter");
              if (!annotation) {
                debugger;
              }
              $(annotation).trigger(mouseenterEvent, ['test']);
              $(e.target).fadeOut(50);
              return $(e.target).fadeIn(50);
            });
            domEl.mouseleave(function(e) {
              var mouseleaveEvent;
              mouseleaveEvent = jQuery.Event("mouseleave");
              if (!annotation) {
                debugger;
              }
              return $(annotation).trigger(mouseleaveEvent, ['test']);
            });
            domEl.click(function() {
              var i, widgets, _results1;
              limeplayer.player.pause();
              _results1 = [];
              for (i in annotation.widgets) {
                if (i !== "AnnotationOverlays") {
                  widgets = annotation.widgets[i];
                  _results1.push(widgets.addClass("highlighted").delay(2000).queue(function(next) {
                    $(this).removeClass("highlighted");
                    return next();
                  }));
                } else {
                  _results1.push(void 0);
                }
              }
              return _results1;
            });
            annotation.widgets.AnnotationOverlays = domEl;
            return domEl;
          }
        });
        _results.push(jQuery(annotation).bind("becomeInactive", function(e) {
          annotation = e.annotation;
          if (annotation.end === 5) {
            console.info(annotation);
          }
          if (annotation.isSpacial && (annotation.w > 0) && (annotation.h > 0)) {
            annotation.widgets.AnnotationOverlays.remove();
            return delete annotation.widgets.AnnotationOverlays;
          } else {
            return false;
          }
        }));
      }
      return _results;
    };

    AnnotationOverlays.prototype.renderAnnotation = function(annotation) {
      var label, props, unit,
        _this = this;
      if (annotation.ldLoaded) {
        props = annotation.entity[annotation.resource.value];
        label = _(props["http://www.w3.org/2000/01/rdf-schema#label"]).detect(function(labelObj) {
          return labelObj.lang === _this.lime.options.preferredLanguage;
        }).value;
      }
      if (label === undefined) {
        label = "";
      }
      unit = annotation.isPercent ? "%" : "px";
      return "<div class='spatial_annotation' style='position: absolute; width: " + annotation.w + unit + "; height: " + annotation.h + unit + "; left: " + annotation.x + unit + "; top: " + annotation.y + unit + "'>" + label + "</div>";
    };

    return AnnotationOverlays;

  })(window.LimePlugin);

  _V_.AnnotationOverlaysComponent = _V_.Component.extend({
    options: {
      loadEvent: "play"
    },
    init: function(player, options) {
      this._super(player, options);
      return this.player.AnnotationOverlaysComponent = this;
    },
    createElement: function() {
      var d;
      d = _V_.createElement("div", {
        className: "annotation-overlays-wrapper"
      });
      return d;
    },
    fadeIn: function() {
      return this._super();
    },
    fadeOut: function() {
      return this._super();
    },
    lockShowing: function() {
      return this.el.style.opacity = "1";
    }
  });

}).call(this);
